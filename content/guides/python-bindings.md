---
title: Python Bindings
weight: 40
---

`cellular_raza` was designed such that it can be used as a numerical backend for `python`
applications.
We use [`pyo3`](https://pyo3.rs/) to automatically generate these bindings and install the
resulting package in a local virtual environment.
In the past we have created multiple projects where we used python bindings to create one concise
package ([cr_mech_coli](https://github.com/jonaspleyer/cr_mech_coli/),
[cr_trichome](https://github.com/jonaspleyer/cr_trichome)).
It is also possible to distribute such a package on [pypy.org](https://pypi.org/).

## cellular_raza-template-pyo3

We provide the template repository
[cellular_raza-template-pyo3](https://github.com/jonaspleyer/cellular_raza-template-pyo3) which
makes it easy to get started with a new mixed Rust-Python project with `cellular_raza`.

### Layout

{{< filetree/container >}}
    {{< filetree/folder name="cellular_raza_template_pyo3" >}}
        {{< filetree/file name="cellular_raza_template_pyo3.pyi" >}}
        {{< filetree/file name="__init__.py" >}}
    {{< /filetree/folder >}}
    {{< filetree/folder name="docs" state="closed" >}}
        {{< filetree/folder name="_build" />}}
        {{< filetree/folder name="_static" />}}
        {{< filetree/file name="Makefile" >}}
        {{< filetree/file name="conf.py" >}}
        {{< filetree/file name="index.rst" >}}
        {{< filetree/file name="make.bat" >}}
        {{< filetree/file name="references.bib" >}}
        {{< filetree/file name="requirements.txt" >}}
    {{< /filetree/folder >}}
    {{< filetree/folder name="examples" state="closed">}}
        {{< filetree/file name="basic.py" >}}
    {{< /filetree/folder >}}
    {{< filetree/folder name="src" >}}
        {{< filetree/file name="lib.rs" >}}
    {{< /filetree/folder >}}
    {{< filetree/file name="Cargo.toml" >}}
    {{< filetree/file name="LICENSE" >}}
    {{< filetree/file name="README.md" >}}
    {{< filetree/file name="pyproject.toml" >}}
    {{< filetree/file name="requirements.txt" >}}
{{< /filetree/container >}}

{{< callout type="info" >}}
Many of these files and their contents of this project should be renamed to the new project name.
A full list is contained inside the `README.md` file.
{{< /callout >}}

The source code of this project is split between the `src` and `cellular_raza_template_pyo3`
folders.

#### Python Files

The `cellular_raza_template_pyo3` folder is named identically to the project and should be renamed
to the new project name.
It contains all python source code and is structured like a python project together with the
`requirements.txt` and `pyproject.toml` files.
The latter contains additional information for [maturin](https://github.com/PyO3/maturin) which we
use for building and publishing.

{{< details title="`pyproject.toml`" closed="true">}}
{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/pyproject.toml"
    filename="pyproject.toml"
>}}
{{< /details >}}

Within the `cellular_raza_template_pyo3` folder is a `*.pyi`
[stub file](https://typing.readthedocs.io/en/latest/spec/distributing.html#stub-files) which
provide type information about the objects generated by `pyo3`.
Unfortunately it is currently not possible to automatically generate these files (see
[github.com/PyO3/pyo3/issues/2454](https://github.com/PyO3/pyo3/issues/2454)).

#### Rust Files

The `src` folder contains all code written in Rust.
Together with the `Cargo.toml` file it acts as a regular Rust-Cargo project.
It exports functions and classes inside a module from the `lib.rs` file.

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="135"
>}}

The name of this module should also be changed when building a new project.
Functions and object need to be annotated with the `#[pyfunction]` and `#[pyclass]` derive macros
respectively.
See the documentation of [`pyo3`](https://pyo3.rs/).

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="51"
    end="53"
>}}

options="{\"hl_lines\" \"51-53\"}"

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="66"
    end="67"
>}}

#### Docs

The `docs` folder contains files for generating documentation with
[sphinx](https://www.sphinx-doc.org/en/master/).
It integrates well within these projects and can be configured very freely.
Since we aim to provide a python package in the end, we will have to adapt the same approach in
writing docstrings for our Rust-based code.

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="37"
    end="39"
>}}

### Simulation Flow

The overall structure of this template project is similar to that of the
[getting-started](/guides/getting-started) guide.
We define an `Agent` struct and derive its properties from already existing building blocks.

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="50"
    end="60"
>}}

All settings required to run a new simulation are stored in the `SimulationSettings` struct.

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="20"
    end="33"
>}}

This information is then used to initialize all agents and the simulation domain within the
`run_simulation` function.

{{< details title="`run_simulation`" closed="true" >}}
{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="62"
    end="133"
>}}
{{< /details >}}

This functionality is then exported as python functions.

{{< codeFromFile
    file="cellular_raza/cellular_raza-examples/cellular_raza-template-pyo3/src/lib.rs"
    filename="src/lib.rs"
    start="135"
    end="140"
>}}

For now, the adjoining python code in `./cellular_raza_template_pyo3` is empty and only re-exports
these objects and functions.

### Troubleshooting & Caveats
#### `pyo3` Versions
The `pyo3` version which we are using in our project and that of `cellular_raza` needs to match.
Otherwise compilation of the project will fail.

#### Generics

Since `pyo3` does not support generics, we can not expose any classes that use generics directly.
If we wish to use any class with generics, we need to write wrappers around them.

#### Docstrings and LSP

Sphinx inspects the generated python object itself while most language servers rely on the inline
docstrings from the python source code or `*.pyi` stub files.
This means that the documentation of our python code which comes from Rust will show the contents
of docstrings given in `src/...` while the syntax highlighting and completion will show the
content of the stub file `cellular_raza_template_pyo3/cellular_raza_template_pyo3.pyi`.
